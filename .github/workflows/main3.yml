name: QEMU Cloudflare Fast VNC
on: workflow_dispatch

jobs:
  run-win11:
    runs-on: macos-13
    
    steps:
    - name: Install Dependencies
      run: |
        brew install qemu
        brew install cloudflared

    - name: Download Win11 ISO
      run: |
        curl -L -o win11.iso "https://archive.org/download/mul_windows_7_enterprise_with_sp1_x64_dvd_u_677651-Archive/mul_windows_7_enterprise_jun_2024_x64_custom.iso"
    - name: Create Disk
      run: qemu-img create -f qcow2 windows.qcow2 40G

    - name: Setup noVNC (Lightweight)
      run: |
        git clone https://github.com/novnc/noVNC.git
        git clone https://github.com/novnc/websockify noVNC/utils/websockify
        ./noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 > novnc.log 2>&1 &

    - name: Start VM (Optimized for Speed)
      # تغییرات مهم:
      # -vga std: گرافیک ساده‌تر و سبک‌تر
      # -vnc :0,lossy=on: فعال‌سازی فشرده‌سازی شدید برای اینترنت ضعیف
      run: |
        sudo qemu-system-x86_64 \
          -m 6G \
          -smp 4 \
          -cpu host \
          -accel hvf \
          -drive file=windows.qcow2,if=virtio \
          -cdrom win11.iso \
          -boot d \
          -vga std \
          -display vnc=:0,lossy=on \
          -usb -device usb-tablet \
          -daemonize

    - name: Start Cloudflare Tunnel
      run: |
        cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
        sleep 10
        
    - name: Get Optimized Link
      run: |
        TUNNEL_URL=$(grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1)
        echo "----------------------------------------"
        echo "SPEED LINK (Low Quality, Fast Speed):"
        # اضافه کردن پارامترهای quality=3 و compression=9 به لینک
        echo "$TUNNEL_URL/vnc.html?autoconnect=true&quality=3&compression=9"
        echo "----------------------------------------"
        while true; do sleep 30; done
        
