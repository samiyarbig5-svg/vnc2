name: QEMU Cloudflare Fast VNC
on: workflow_dispatch

jobs:
  run-win11:
    runs-on: macos-13
    
    steps:
    - name: Install Dependencies
      run: |
        brew install qemu
        brew install cloudflared

    - name: Download Win11 ISO
      run: |
        curl -L -o win11.iso "https://software.download.prss.microsoft.com/dbazure/Win11_25H2_English_x64.iso?t=4680c4ce-b0ab-4c61-87e7-0df9bbd03422&P1=1763874804&P2=601&P3=2&P4=eG2bQk2alRkObmsUkNQL%2fxPCxY%2bl%2blRpgusDR8wSJXXPbfnH9t6zzT9hqkAGwTQjWlUHvKMrFoqlVh351E22VapPP36IftbxgF69GxDwb2Lx2zwD71lpyhF217zJ%2fu91E12c9a4W2uln%2bqW5gtbArOSFgfSsPp23094O7oe47L4EKQN9uLbxm066%2fpYUjKGKrbcRpsU18BXHGgHVwonX1AXH58hQ19lg7LI1pz%2bWJsKyw6KsPhfBzKqn5tCohA%2bntgi9Ddx5y2PyjqgEBcs%2fWBkqR6CQGekomOyiCZDdWJwoJR6c9d%2fvhyIaUGsehWeTrv1GlpUZYEKjE7elRlHOPQ%3d%3d"

    - name: Create Disk
      run: qemu-img create -f qcow2 windows.qcow2 40G

    - name: Setup noVNC (Lightweight)
      run: |
        git clone https://github.com/novnc/noVNC.git
        git clone https://github.com/novnc/websockify noVNC/utils/websockify
        ./noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 > novnc.log 2>&1 &

    - name: Start VM (Optimized for Speed)
      # تغییرات مهم:
      # -vga std: گرافیک ساده‌تر و سبک‌تر
      # -vnc :0,lossy=on: فعال‌سازی فشرده‌سازی شدید برای اینترنت ضعیف
      run: |
        sudo qemu-system-x86_64 \
          -m 6G \
          -smp 4 \
          -cpu host \
          -accel hvf \
          -drive file=windows.qcow2,if=virtio \
          -cdrom win11.iso \
          -boot d \
          -vga std \
          -display vnc=:0,lossy=on \
          -usb -device usb-tablet \
          -daemonize

    - name: Start Cloudflare Tunnel
      run: |
        cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
        sleep 10
        
    - name: Get Optimized Link
      run: |
        TUNNEL_URL=$(grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1)
        echo "----------------------------------------"
        echo "SPEED LINK (Low Quality, Fast Speed):"
        # اضافه کردن پارامترهای quality=3 و compression=9 به لینک
        echo "$TUNNEL_URL/vnc.html?autoconnect=true&quality=3&compression=9"
        echo "----------------------------------------"
        while true; do sleep 30; done
        
