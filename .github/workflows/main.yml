name: QEMU Tailscale Fixed

on: workflow_dispatch

jobs:
  run-win11:
    runs-on: macos-13
    
    steps:
    - name: Install QEMU
      run: brew install qemu

    - name: Download Win11 ISO
      # لینک مستقیم دانلود ISO را اینجا بگذارید
      run: |
        curl -L -o win11.iso "https://cdimage.debian.org/debian-cd/13.2.0-live/amd64/iso-hybrid/debian-live-13.2.0-amd64-lxqt.iso"
    - name: Create Disk
      run: qemu-img create -f qcow2 windows.qcow2 40G

    - name: Setup Tailscale (Safe Mode)
      # این روش امن‌ترین راه برای جلوگیری از ارور سینتکس است
      env:
        TS_KEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      run: |
        brew install tailscale
        sudo tailscaled > tailscaled.log 2>&1 &
        sleep 15
        sudo tailscale up --authkey="$TS_KEY" --hostname="macos-win11-runner"

    - name: Get Connection Info
      run: |
        TS_IP=$(tailscale ip -4)
        echo "----------------------------------------"
        echo "Connect VNC to: $TS_IP:5900"
        echo "----------------------------------------"

    - name: Start VM
      run: |
        sudo qemu-system-x86_64 \
          -m 6G \
          -smp 4 \
          -cpu host \
          -accel hvf \
          -drive file=windows.qcow2,if=virtio \
          -cdrom win11.iso \
          -boot d \
          -vga virtio \
          -display vnc=:0 \
          -usb -device usb-tablet
          
