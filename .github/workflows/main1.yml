name: Win11 Max Power (Cloudflare Web)

on: workflow_dispatch

jobs:
  run-win11-max:
    runs-on: macos-13
    
    steps:
    - name: Check Hardware Specs
      # Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ± Ø¨Ù‡ Ø´Ù…Ø§ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ú©Ù‡ Ø³Ø±ÙˆØ± ÙˆØ§Ù‚Ø¹Ø§ Ú†Ù‚Ø¯Ø± Ù‚Ø¯Ø±Øª Ø¯Ø§Ø±Ø¯
      run: |
        echo "--------------------------------"
        echo "System Memory (RAM):"
        sysctl hw.memsize | awk '{print $2/1073741824 " GB"}'
        echo "CPU Cores:"
        sysctl hw.ncpu
        echo "--------------------------------"

    - name: Install Tools
      run: |
        brew install qemu aria2 cloudflared
        brew install python@3.11
        pip3.11 install websockify
        git clone https://github.com/novnc/noVNC.git

    - name: Download Win11 (Stable)
      run: aria2c -x 16 -s 16 -o win11.iso "https://go.microsoft.com/fwlink/p/?LinkID=2195166&clcid=0x409&culture=en-us&country=US"

    - name: Create Disk
      run: qemu-img create -f qcow2 windows.qcow2 64G

    - name: Start QEMU (Max Safe Specs)
      run: |
        # RAM: 11G (Ø­Ø¯Ø§Ú©Ø«Ø± Ø§Ù…Ù†. Ø§Ú¯Ø± 12 ÛŒØ§ Ø¨ÛŒØ´ØªØ± Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯ Ø³ÛŒØ³ØªÙ… Ù‡Ù†Ú¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯)
        # CPU: 6 (Ø­Ø¯Ø§Ú©Ø«Ø± ØªØ±Ø¯ Ù…Ø¬Ø§Ø²ÛŒ)
        sudo qemu-system-x86_64 \
          -m 11G \
          -smp 6 \
          -cpu host \
          -accel hvf \
          -drive file=windows.qcow2,if=virtio \
          -cdrom win11.iso \
          -boot d \
          -vga virtio \
          -display vnc=:0 \
          -device usb-tablet \
          -net nic,model=virtio \
          -net user,hostfwd=tcp::3389-:3389 &
        
        sleep 5
        
        # Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ ÙˆØ¨ Ø³ÙˆÚ©Øª Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø±
        ./noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &

    - name: Start Cloudflare Tunnel
      run: |
        sleep 5
        cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
        
        sleep 10
        echo "======================================================="
        echo "ðŸš€ ÙˆÛŒÙ†Ø¯ÙˆØ² Ø¨Ø§ Ø­Ø¯Ø§Ú©Ø«Ø± Ù‚Ø¯Ø±Øª Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª!"
        echo "ðŸ”— Ø±ÙˆÛŒ Ù„ÛŒÙ†Ú© Ø²ÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯:"
        grep -o "https://.*.trycloudflare.com" tunnel.log | head -n 1
        echo "======================================================="
        
        sleep 21600
        
